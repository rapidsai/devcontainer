name: push-image

description: Build and push image

inputs:
  dir:
    type: string
    required: true
    description: Image dir
  tag:
    type: string
    required: true
    description: Image tag
  arch:
    type: string
    required: true
    description: Image arch
  home:
    type: string
    required: true
    description: Runner HOME dir

runs:
  using: composite
  steps:

    - name: Dump runner context
      shell: bash
      run: |
        echo "${{ toJSON(runner) }}"
        echo "is_gha_runner=${{ !contains(runner.name, 'rapidsai') }}" >> $GITHUB_ENV

    - name: Free up disk space
      if: env.is_gha_runner == 'true'
      uses: ./.github/actions/free-disk-space
      with:
        home: "${{ inputs.home }}"
        tool_cache: "${{ runner.tool_cache }}"

    - name: Setup runner environment
      if: env.is_gha_runner != 'true'
      shell: bash
      run: |
        echo "TMPDIR=/data/_temp" >> $GITHUB_ENV;
        data="${{ runner.workspace }}/../";
        data="$(realpath -m "$data")";
        sudo ln -s "$data" "/data";
        sudo chown -R $(id -u):$(id -g) "/data";
        sudo chown -R $(id -u):$(id -g) "$data";

    - name: Setup Node.js
      if: env.is_gha_runner != 'true'
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Setup Docker Buildx context
      shell: bash
      run: |
        docker context create builders

    - name: Setup Docker buildx
      uses: docker/setup-buildx-action@v2
      with:
        use: true
        endpoint: builders
        buildkitd-flags: --debug

    - name: Login to ghcr.io
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ github.token }}

    - name: Build and push ghcr.io/${{ github.repository }}:${{ inputs.tag }}-${{ inputs.arch }}
      uses: devcontainers/ci@v0.2
      with:
        push: always
        skipContainerUserIdUpdate: true
        # Skip setting this so skopeo isn't required
        # platform: linux/${{ inputs.arch }}
        subFolder: images/${{ inputs.dir }}
        imageName: ghcr.io/${{ github.repository }}
        imageTag: ${{ inputs.tag }}-${{ inputs.arch }}
        cacheFrom: ghcr.io/${{ github.repository }}:${{ inputs.tag }}-${{ inputs.arch }}
