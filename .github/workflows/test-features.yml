name: Test features

concurrency:
  group: test-features-on-${{ github.event_name }}-from-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:

jobs:

  matrix:
    name: Determine matrix
    runs-on: ubuntu-latest
    outputs:
      features: ${{ steps.matrix.outputs.features }}
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - id: matrix
        name: Determine matrix
        uses: ./.github/actions/feature-matrix

  test-autogenerated:
    name: Generated
    needs: matrix
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.arch }}
      - cpu4
    continue-on-error: true
    strategy:
      max-parallel: 2
      fail-fast: true
      matrix:
        arch: [amd64, arm64]
        feature: ${{ fromJSON(needs.matrix.outputs.features) }}
        image:
          # - debian:latest
          - ubuntu:jammy
          - mcr.microsoft.com/devcontainers/base:jammy
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Setup runner environment
        uses: ./.github/actions/setup-runner-env
        with:
          arch: ${{ matrix.arch }}

      - name: Copy common scripts into features
        uses: ./.github/actions/copy-common-scripts
      - name: Install devcontainers CLI
        uses: ./.github/actions/install-devcontainers-cli

      - name: Generating tests for '${{ matrix.feature }}' against '${{ matrix.image }}'
        run: devcontainer features test --log-level trace --skip-scenarios -f ${{ matrix.feature }} -i ${{ matrix.image }} ./features

  test-scenarios:
    name: Scenarios
    needs: matrix
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.arch }}
      - cpu4
    continue-on-error: true
    strategy:
      max-parallel: 2
      fail-fast: true
      matrix:
        arch: [amd64, arm64]
        feature: ${{ fromJSON(needs.matrix.outputs.features) }}
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Setup runner environment
        uses: ./.github/actions/setup-runner-env
        with:
          arch: ${{ matrix.arch }}

      - name: Copy common scripts into features
        uses: ./.github/actions/copy-common-scripts
      - name: Install devcontainers CLI
        uses: ./.github/actions/install-devcontainers-cli

      - name: Generating tests for '${{ matrix.feature }}' scenarios
        run: devcontainer features test --log-level trace -f ${{ matrix.feature }} --skip-autogenerated ./features

  test-global:
    name: Integration
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.arch }}
      - cpu4
    continue-on-error: true
    strategy:
      max-parallel: 2
      fail-fast: true
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Setup runner environment
        uses: ./.github/actions/setup-runner-env
        with:
          arch: ${{ matrix.arch }}

      - name: Copy common scripts into features
        uses: ./.github/actions/copy-common-scripts
      - name: Install devcontainers CLI
        uses: ./.github/actions/install-devcontainers-cli

      - name: Testing global scenarios
        run: devcontainer features test --log-level trace --global-scenarios-only ./features
