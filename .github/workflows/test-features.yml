name: Test features

concurrency:
  group: test-features-on-${{ github.event_name }}-from-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:

jobs:

  matrix:
    name: Determine matrix
    runs-on: ubuntu-latest
    outputs:
      features: ${{ steps.matrix.outputs.features }}
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - id: matrix
        name: Determine matrix
        uses: ./.github/actions/feature-matrix

  test-autogenerated:
    name: Generated
    needs: matrix
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.arch }}
      - cpu4
    continue-on-error: true
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        feature: ${{ fromJSON(needs.matrix.outputs.features) }}
        image:
          # - debian:latest
          - ubuntu:jammy
          - mcr.microsoft.com/devcontainers/base:jammy
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - uses: ./.github/actions/install-devcontainers-cli
      - uses: ./.github/actions/copy-common-scripts

      - name: Generating tests for '${{ matrix.feature }}' against '${{ matrix.image }}'
        run: devcontainer features test --skip-scenarios -f ${{ matrix.feature }} -i ${{ matrix.image }} ./features

  test-scenarios:
    name: Scenarios
    needs: matrix
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.arch }}
      - cpu4
    continue-on-error: true
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        feature: ${{ fromJSON(needs.matrix.outputs.features) }}
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - uses: ./.github/actions/install-devcontainers-cli
      - uses: ./.github/actions/copy-common-scripts

      - name: Generating tests for '${{ matrix.feature }}' scenarios
        run: devcontainer features test -f ${{ matrix.feature }} --skip-autogenerated ./features

  test-global:
    name: Integrated
    runs-on:
      - self-hosted
      - linux
      - ${{ matrix.arch }}
      - cpu4
    continue-on-error: true
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - uses: ./.github/actions/install-devcontainers-cli
      - uses: ./.github/actions/copy-common-scripts

      - name: Testing global scenarios
        run: devcontainer features test --global-scenarios-only ./features
